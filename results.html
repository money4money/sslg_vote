<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Election Results - SMNHS SSLG</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="results-container">
        <header>
            <h1>SSLG ELECTION LIVE RESULTS</h1>
            <div class="last-updated" id="lastUpdated">
                ⏳ Loading latest votes...
            </div>
        </header>

        <main id="resultsContainer"></main>

        <footer>
            <p>Results update in real-time • San Miguel National High School</p>
            <p>Powered by Firebase • Updated: <span id="updateTime"></span></p>
        </footer>
    </div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDgxT2abVQ9IijpK7mPtSVR8MB9_avt5nY",
    authDomain: "smnhs-g-vote.firebaseapp.com",
    projectId: "smnhs-g-vote",
    storageBucket: "smnhs-g-vote.appspot.com",
    messagingSenderId: "416427442626",
    appId: "1:416427442626:web:4249dfb15d5892b144965b",
    measurementId: "G-RJHT21GX7Q"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Real-time Results Listener
db.collection("votes").onSnapshot((snapshot) => {
    const results = {};
    const now = new Date();
    
    // Update timestamps
    document.getElementById('lastUpdated').textContent = `Last update: ${now.toLocaleTimeString()}`;
    document.getElementById('updateTime').textContent = now.toLocaleDateString();

    // Process all votes
    snapshot.forEach(doc => {
        const voteData = doc.data().votes;
        Object.entries(voteData).forEach(([position, candidate]) => {
            if(!results[position]) results[position] = {};
            results[position][candidate] = (results[position][candidate] || 0) + 1;
        });
    });

    displayResults(results);
}, (error) => {
    document.getElementById('lastUpdated').textContent = "⚠️ Error loading results!";
    console.error("Firestore error:", error);
});

function displayResults(results) {
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '';

    // Define positions in order
    const positionsOrder = [
        'President', 
        'VicePresident', 
        'Secretary', 
        'Treasurer', 
        'Auditor', 
        'PublicInformationOfficer', 
        'ProtocolOfficer',
        'Grade8Rep',
        'Grade9Rep',
        'Grade10Rep',
        'Grade11Rep',
        'Grade12Rep'
    ];

    positionsOrder.forEach(position => {
        if(!results[position]) return;

        const sorted = Object.entries(results[position])
            .sort((a, b) => b[1] - a[1]);

        const positionHTML = `
            <section class="position-card">
                <h2>${formatPositionName(position)}</h2>
                <div class="candidates-list">
                    ${sorted.map(([name, votes]) => `
                        <div class="candidate-row">
                            <div class="candidate-info">
                                <span class="candidate-name">${name}</span>
                                <span class="vote-percent">${calculatePercentage(votes, sorted)}%</span>
                            </div>
                            <div class="vote-progress">
                                <div class="progress-bar" style="width: ${calculatePercentage(votes, sorted)}%"></div>
                            </div>
                            <div class="vote-count">${votes}</div>
                        </div>
                    `).join('')}
                </div>
            </section>
        `;
        
        container.innerHTML += positionHTML;
    });
}

function formatPositionName(pos) {
    return pos
        .replace(/([A-Z])/g, ' $1')
        .replace('Rep', ' Representative')
        .replace(/^\w/, c => c.toUpperCase());
}

function calculatePercentage(votes, allCandidates) {
    const total = allCandidates.reduce((sum, [_, votes]) => sum + votes, 0);
    return ((votes / total) * 100).toFixed(1);
}
</script>
</body>
</html>
